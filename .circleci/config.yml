version: 2.1
executors:
  docker:
    docker:
      - image: cimg/base:stable
jobs:
  build:
    parameters:
      jdk-version:
        type: string
    working_directory: ~/sailor-jvm
    executor: docker
    docker:
      - image: << parameters.jdk-version >>
      - image: rabbitmq:3.8.3
    steps:
      - checkout
      - run:
          name: Audit Dependencies
          command: ./gradlew dependencyCheckAnalyze
      - run: export TERM=${TERM:-dumb} && ./gradlew build --refresh-dependencies
      - store_test_results:
          path: build/reports
  publish:
    executor: docker
    steps:
      - run: export TERM=${TERM:-dumb} && ./gradlew publish -PsonatypeUsername=$SONATYPE_USERNAME -PsonatypePassword=$SONATYPE_PASSWORD
workflows:
  test_different_java:
    jobs:
      - build:
          name: "Run Sailor tests against different JDK versions"
          matrix:
            parameters:
              jdk-version: ["amazoncorretto:8-alpine-jdk", "amazoncorretto:11-alpine-jdk", "amazoncorretto:18-alpine-jdk"]
  publish_release:
    jobs:
      - publish:
          name: "Publish artifacts to Maven"
